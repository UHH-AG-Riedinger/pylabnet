//This Code is placed inside the Arudino so it know what to od when we send a message from the Python Code to the Arduino
//Careful this code is written in C++ and not in python
#include <Arduino.h>
#include <math.h>

#define PI 3.1415926535897932384626433832795

String message;
int counter = 1;
int bits = 10;
int voltage_bits = 0;
int stringCount = 0;

float minimum_Voltage = 0.535;
float maximum_Voltage = 2.75;
float full_possible_angle = 13.29;
float minimum_angle_step = 13.29/1024;

int x_default = 512;
int y_default = 812;


String realmessage;


void setup() {
  //analogWrite(DAC1,0);//delte next time
  Serial.begin(115200);
  Serial.setTimeout(2); // If lower it does not have enough time to send all Inforamtion from Python
  pinMode(LED_BUILTIN, OUTPUT);
  analogWriteResolution(bits);
  Serial.flush();
  digitalWrite(LED_BUILTIN, LOW);
}



void  loop() {
  while (!Serial.available());
  if (message != "");
    message = Serial.readStringUntil(';');
  //message.trim();

  //voltage_bits = message.substring(4).toInt();

  if (message== "DAC1"){
    message = Serial.readString();
    analogWrite(DAC1, message.toInt());
    String back_message = String("Applied value of " + message);
    Serial.write(back_message.c_str());
    message = "";
  }
  else if (message == "DAC0"){
    message = Serial.readString();
    analogWrite(DAC0, message.toInt());
    String back_message = String("Applied value of " + message);
    Serial.write(back_message.c_str());
    message = "";
  }

 else if(message == "center")
  {
    message = Serial.readStringUntil(';');
     x_default = message.toDouble();

    message = Serial.readString();
    y_default = message.toDouble();
    digitalWrite(LED_BUILTIN, HIGH);
    message = "";


  }


//This function makes no sense for now because there are length differences defined yet
  // else if(message == "area")
  // {
  //   digitalWrite(LED_BUILTIN, HIGH);
  //   message = Serial.readStringUntil(';');
  //   double x_length = message.toDouble();

  //   message = Serial.readStringUntil(';');
  //   double y_hight = message.toDouble();

  //   message = Serial.readStringUntil(';');
  //   double dist = message.toDouble();

  //   //now scan area
  //   double amount_of_steps_x = 360/(2*PI*minimum_angle_step)*asin(x_length/dist);
  //   double amount_of_steps_y = 360/(2*PI*minimum_angle_step)*asin(y_hight/dist);

  //   int x_steps = int(round(amount_of_steps_x));
  //   int y_steps = int(round(amount_of_steps_y));

  //   String back_message = "";
  //   if(amount_of_steps_x <1){
  //       back_message = "Angle resolution too small for x_length!!! Need smaller steps or lower distance! "+x_steps ;  // noqa: E501
  //   }
  //   if(amount_of_steps_y <1){
  //       back_message = "Angle resolution too small for y_hight!!! Need smaller steps or lower distance! Steps: "+ y_steps;  // noqa: E501
  //   } 

  //   back_message = String(back_message + "- Done");
  //   Serial.write(back_message.c_str());

  //   for (int i = 0; i< y_steps; i++)
  //   {
  //     analogWrite(DAC0, i);

  //     for (int k = 0; k<= x_steps;k++)
  //     {

        
  //       analogWrite(DAC1, k);
  //       delayMicroseconds(100);
  //     }
  //     delayMicroseconds(10000);

  //   }
  // }

  else if(message == "areaStep")
  {
    message = Serial.readStringUntil(';');
    x_default = message.toInt();

    message = Serial.readStringUntil(';');
    y_default = message.toInt();

    message = Serial.readStringUntil(';');
    double x_steps = message.toDouble();

    message = Serial.readStringUntil(';');
    double y_steps = message.toDouble();

    message = Serial.readString();
    double times = message.toInt();


    if (times == 0)
    {
      times = 2147483646;
    }
    message = "";

    for (int counter = 0; counter <= times; counter++)
    {

      for (int i = y_default-y_steps/2; i< y_default+y_steps/2; i++)
      {
        analogWrite(DAC1, i);

        for (int k = x_default-x_steps/2; k<= x_default+x_steps/2;k++)
        {
          analogWrite(DAC0, k);
          ////delayMicroseconds(10);
        }
        delayMicroseconds(1);

      }
      message = Serial.readStringUntil(';');
      if (message != "")
        break;

      
    }


    //Serial.write(times);
  }

  //geht nicht richtig
  else if (message == "pict"){
    //int charArray[1024][1024] = 0


    //for(int i = 0; i<=1023;i++)
    message = Serial.readString();
    //some symbol :
    const char something[] = "0000000000000000000000000000000000000000000000111000111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000000111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000000000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000110000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000011000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000000000110000000000000000000000000000000000000000000000000000000000000110000000000000000000000001110000001110000000000000000000000001100000000000000000000000000000000011100111000000000000000000000001101101100000000000000000000000111001110000000000000000000000000000011000000110000000000000000000000011001100000000000000000000000110000001100000000000000000000000000001000000001000000000000000000000001000010000000000000000000000110000000010000000000000000000000000001100000000010000000000000000000000100001000000000000000000000010000000001000000000000000000000000000100000000001000000000000000000000010000100000000000000000000001000000000100000000000000000000000000010000000000100000000000000000000001000010000000000000000000000100000000001000000000000000000000000001000000000010000000000000000000000100001000000000000000000000010000000001000000000000000000000000000010000000010000000000000000000000010000100000000000000000000000100000000100000000000000000000000000001100000011000000000000000000000001000010000000000000000000000011000000110000000000000000000000000000011100111001000000000000000000000100001000000000000000000001100110001110000000000000000000000000000000001100010010000000000000000000010000100000000000000000001100100111000000000000000000000000000000000000000001100100000000000000000001000010000000000000000001100110000000000000000000000000000000000000000000000011001100000000000000000100001000000000000000001100110000000000000000000000000000000000000000000000000110010000000000000000010000100000000000000001100110000000000000000000000000000000000000000000000000001101000000000000000001000100000000000000000100100000000000000000000000000000000000000000000000000000000000000000000000000100010000000000000000000000000000000000000000000000000000000000000000000011111111111111111111100000010001000000001111111111111111111100000000000000000000000000000000000011110000000000000000000001111100000100111111000000000000000000001111000000000000000000000000000000111000000111111111111110000000011010011100000000011111111111111000000111000000000000000000000000000110000111100000000000000111111100110000000001111110000000000000011111000110000000000000000000000000110011100000000000000011000000100000000010000100000100100000000000000011000100000000000000000000000110011000000000000000011001001110000000010100011100100110000000000000000111001000000000000000000000010010000000000000000000000011000001111001011100001100010000000000000000000110110000000000000000000010010000000000000000000011110000111000100100001110001111000000000000000000001001000000000000000000001001000000000000000000111000011100000110011000001111000111000000000000000000010100000000000000000000100100000000000000001110001110001011110000111101000011000111111110000000000001010000000000000000000010010000000000000011100011001000110000011100001100110011000000001100000000000101000000000000000000001001000000000000111000111000011010000000000000010110000011100000010000000000010100000000000000000000100100000000001110001100000000111000000000000000110000000011000001100000000010010000000000000000000001011000000001100011000000000010000000000000000001000000000110000011000000011010000000000000000000000100110000011000111000000000011000000000000000000100000000001100000110000001001000000000000000000000001001000011001110000000000001000000000000000000001000000000001111001110001101100000000000000000000000110010110001100000000000000100000000000000000000100000000000000110001101100100000000000000000000000001101110011100000000000000100000000000000000000010000000000000000110011100100000000000000000000000000010010011000000000000000010000000000000000000000100000000000000001100000100000000000000000000000000000100000000000000000000001000000000000000000000010000000000000000001000100000000000000000000000000000110100110000000000000000100000000000000000000010000000000000000011001101000000000000000000000000000110001001100000000000000010000000000000000000001000000000000000011001100010000000000000000000000000110011110001100000000000000100000000000000000000100000000000000111001101101100000000000000000000000010011000110011100000000000010000000000000000000010000000000000110001100010011000000000000000000000010011000001100011000000000001000000000000000000010000000000001100011000000100100000000000000000000001011000000011100011000000000001111000000000011110000000000011100111000000011010000000000000000000001001000000000011100011000000001101000000000001001100000000111000110000000000100100000000000000000000100100000000000011100011000011100110000000000110011000001110001100000000000001010000000000000000000010010000000000000011100011011000110000000000001100110011100011100000000000000101000000000000000000001001000000000000000011100010000010111100001110011001110000111000000000000000010100000000000000000000100100000000000000000011100001110000010110100000100000001110000000000000000001010000000000000000000010010000000000000000000011000001110000100100001110000011000000000000000000001001000000000000000000001101100000000000000000010000010000111000010111000000000010000000000000000001101100000000000000000000010011100000000000000011000110111000011111010001111110001100000000000000001100100000000000000000000000100011000000000000011000100000000100000111000000000000011000000000000011000110000000000000000000000001100011110000000011000000011111001111000000111110000000110000000011110001110000000000000000000000000011100000111111111000011110000000100111110000000111100001111111111000001100000000000000000000000000000001110000000000000000000001111110100000111110000000000000000000001111000000000000000000000000000000000000111111101000011111111000000010010000000111111110000101111111000000000000000000000000000000000000000000000101100011000000000000001001000000000000001100011100000000000000000000000000000000000000000000000000110000011000000000000000100100000000000000011000001100000000000000000000000000000000000000001111110010000011000000000000000010010000000000000000110000011111111100000000000000000000000000000011000000110000011000000000000000001001000000000000000001100000000000001100000000000000000000000000111000000000110011000000000000000000100100000000000000000011001100000000011000000000000000000000000010000000000001011000000000000000000010010000000000000000000110100000000000110000000000000000000000011000000000000110000000000000000000001001000000000000000000001000000000000001100000000000000000000001000000000000001000000000000000000000100100000000000000000000100000000000000010000000000000000000001000000000000000010000000000000000000010010000000000000000000010000000000000001000000000000000000000100000000000000001000000000000000000001001000000000000000000001000000000000000100000000000000000000010000000000000000100000000000000000000100100000000000000000000100000000000000010000000000000000000001000000000000000010000000000000000000010010000000000000000000010000000000000001000000000000000000000100000000000000001000000000000000000001001000000000000000000001000000000000000100000000000000000000001000000000000001000000000000000000000100100000000000000000000100000000000000010000000000000000000000100000000000000100000000000000000000010010000000000000000000001000000000000011000000000000000000000011000000000000110000000000000000000001001000000000000000000000110000000000001000000000000000000000000110000000000110000000000000000000000100100000000000000000000001100000000001100000000000000000000000001100000000110000000000000000000000010010000000000000000000000011000000011100000000000000000000000000011110011110000000000000000000000111111100000000000000000000000111100111000000000000000000000000000000000110000000000000000000000000110000011000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000010000000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011000000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110110110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011100110000000000000000000000000000000000000000000000";
    //digitalWrite(LED_BUILTIN, HIGH);
    analogWrite(DAC0, 1023);
    for(int k=0;k<300;k++){

      for(int i =0; i < strlen(something); i++ ) {

      
        if (something[i] == '1'){
          analogWrite(DAC0, (i%100)*10);
          analogWrite(DAC1, int(i/100)*10);
          digitalWrite(LED_BUILTIN, i%2);
          delayMicroseconds(50);
        }
      }
    
    }
    Serial.write("Done");
    // for(int row = 0;row <= 1023; row++){
    //   for (int column =0 ; column <= 1023 ; column++){
    //     if (something[row][column] == 1){
    //       analogWrite(DAC0, (row%2)*1023);
    //       analogWrite(DAC1, column);
    //       delayMicroseconds(100);
    //       //digitalWrite(LED_BUILTIN,row%2);
    //     }
    //     else {
    //       analogWrite(DAC1,(row%2)*1023);
    //     }
    //   }
    // if (something[0][1] == false){
    //     digitalWrite(LED_BUILTIN, HIGH);
    //  }
    message = "";
    analogWrite(DAC1,1023);

    //digitalWrite(LED_BUILTIN, LOW);
  

  }
  else
  {
    //Serial.write(message.c_str());
  }
  //Serial.write("Hallo");
  
 


  //analogWrite(DAC1, 1000*counter);
 //analogWrite(DAC1, 0);

  counter++;
  counter = counter%2;
  // digitalWrite(LED_BUILTIN, counter);
  delayMicroseconds(1000);
  //Serial.print("Done Setting pin "+pin+" on Volatge Bits: "+voltage_bits);
  //Serial.print(1);
  Serial.flush();
}